generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================
// ENUMS
// ======================

enum Role {
  ADMIN
  MANAGER
  INSPECTOR
  CLIENT
}

enum UserStatus {
  ACTIVE
  LOCKED
  DISABLED
}

enum ClientCategory {
  MINE
  INDUSTRIAL
  CONSTRUCTION
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum EquipmentType {
  CRANE
  MOBILE_CRANE
  FORKLIFT
  SERVICE_TRUCK_LIFTING_ATTACHMENTS
  AIR_RECEIVER
  COMPRESSOR
  PRESSURE_VESSEL
  SLINGS_CHAINS_SHACKLES
  HYDRAULIC_JACK
  MECHANICAL_JACK
  SAFETY_HARNESS
  CLAMPS_SHUTTER_CLAMPS
  STEP_LADDERS
}

enum InspectionType {
  THOROUGH_EXAMINATION
  VISUAL_INSPECTION
  LOAD_TEST
  HYDROSTATIC_TEST
  PRESSURE_TEST
  UT_THICKNESS_TEST
  FUNCTIONAL_TEST
  ROPE_CHAIN_CONDITION_CHECK
  SAFETY_COMPLIANCE_CHECK
}

enum InspectionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum PfmeaStatus {
  OPEN
  VERIFIED
  CLOSED
}

enum NcrCategory {
  MAJOR
  MINOR
  OBSERVATION
}

enum NcrStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

// ======================
// USERS
// ======================

model User {
  id               String     @id @default(cuid())
  name             String
  email            String     @unique
  phone            String?
  passwordHash     String
  role             Role       @default(INSPECTOR)
  status           UserStatus @default(ACTIVE)

  failedLoginCount Int        @default(0)
  lockUntil        DateTime?
  lastLoginAt      DateTime?
  lastLoginIp      String?

  clientId         String?
  client           Client?    @relation(fields: [clientId], references: [id], onDelete: SetNull)

  inspections      Inspection[] @relation("InspectorInspections")
  approvals        Inspection[] @relation("ManagerApprovals")

  pfmeaAssigned    PfmeaItem[]  @relation("PfmeaOwner")
  ncrAssigned      Ncr[]        @relation("NcrOwner")

  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([clientId])
}

// ======================
// CLIENTS
// ======================

model Client {
  id          String         @id @default(cuid())
  name        String
  category    ClientCategory
  status      ClientStatus   @default(ACTIVE)
  notes       String?

  sites       ClientSite[]
  contacts    ClientContact[]
  equipment   Equipment[]
  inspections Inspection[]
  pfmeaItems  PfmeaItem[]
  ncrs        Ncr[]
  users       User[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model ClientSite {
  id           String   @id @default(cuid())
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name         String
  locationText String?
  gpsLat       Float?
  gpsLng       Float?

  inspections  Inspection[]
  equipment    Equipment[]
}

model ClientContact {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  fullName String
  position String?
  email    String?
  phone    String?
}

// ======================
// EQUIPMENT
// ======================

model Equipment {
  id                String        @id @default(cuid())
  clientId          String
  client            Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  siteId            String?
  site              ClientSite?   @relation(fields: [siteId], references: [id], onDelete: SetNull)

  equipmentCode     String        @unique
  type              EquipmentType
  serialNumber      String

  manufacturer      String?
  yearOfManufacture Int?
  countryOfOrigin   String?

  swl               Float?
  mawp              Float?
  designPressure    Float?
  testPressure      Float?

  status            String        @default("ACTIVE")
  intervalDays      Int?
  nextDueDate       DateTime?
  lastInspectedAt   DateTime?

  inspections       Inspection[]
  pfmeaItems        PfmeaItem[]
  ncrs              Ncr[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([clientId, serialNumber])
  @@index([clientId, type])
  @@index([nextDueDate])
}

// ======================
// INSPECTIONS
// ======================

model Inspection {
  id                    String           @id @default(cuid())
  inspectionCode        String           @unique

  equipmentId           String
  equipment             Equipment        @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  clientId              String
  client                Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)

  siteId                String?
  site                  ClientSite?      @relation(fields: [siteId], references: [id], onDelete: SetNull)

  inspectorId           String
  inspector             User             @relation("InspectorInspections", fields: [inspectorId], references: [id])

  managerApproverId     String?
  managerApprover       User?            @relation("ManagerApprovals", fields: [managerApproverId], references: [id])

  type                  InspectionType
  datePerformed         DateTime

  findingsText          String?
  nonConformance        Boolean          @default(false)
  certificateIssued     Boolean          @default(false)
  certificateExpiryDate DateTime?
  status                InspectionStatus @default(DRAFT)

  pfmeaItems            PfmeaItem[]
  ncrs                  Ncr[]

  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([clientId, datePerformed])
  @@index([equipmentId, datePerformed])
}

// ======================
// PFMEA
// ======================

model PfmeaItem {
  id                String      @id @default(cuid())

  inspectionId      String
  inspection        Inspection  @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  equipmentId       String
  equipment         Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  clientId          String
  client            Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  failureMode       String
  failureCause      String
  failureEffect     String
  existingControls  String?

  severity          Int
  occurrence        Int
  detection         Int

  rpn               Int
  riskLevel         RiskLevel

  actionOwnerUserId String?
  actionOwner       User?       @relation("PfmeaOwner", fields: [actionOwnerUserId], references: [id], onDelete: SetNull)

  actionDueDate     DateTime?
  verificationNotes String?
  status            PfmeaStatus @default(OPEN)

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([clientId, riskLevel])
}

// ======================
// NCR
// ======================

model Ncr {
  id               String      @id @default(cuid())
  ncrCode          String      @unique

  clientId         String
  client           Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  equipmentId      String
  equipment        Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  inspectionId     String?
  inspection       Inspection? @relation(fields: [inspectionId], references: [id], onDelete: SetNull)

  category         NcrCategory
  description      String

  assignedToUserId String?
  assignedTo       User?       @relation("NcrOwner", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  dueDate          DateTime?
  status           NcrStatus   @default(OPEN)
  closedAt         DateTime?

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([clientId, status])
  @@index([dueDate])
}
